"""
Integration tests for {domain} service with real repository.

Tests service + repository integration without mocks.

USAGE:
1. Copy this file to tests/integration/{domain}/test_service_integration.py
2. Replace {Domain} with capitalized domain name (e.g., Item)
3. Replace {domain} with lowercase domain name (e.g., item)
4. Replace {entity} with entity name (e.g., item)
5. Add/remove tests based on your integration flows
"""

from unittest.mock import patch

import pytest

from app.{domain}.events import {Domain}CreatedEvent
from app.{domain}.repository import {Domain}Repository
from app.{domain}.service import (
    create_{entity},
    delete_{entity},
    get_all_{domain}s,
    get_{entity},
    update_{entity},
)
from app.shared.events import EventBus
from tests.fixtures.{domain}s import (
    create_test_{entity}_create_request,
    create_test_{entity}_update_request,
)


@pytest.mark.integration
class Test{Domain}ServiceIntegration:
    """Test {domain} service with real repository."""

    @pytest.mark.asyncio
    async def test_create_and_get_{entity}_integration(self, test_db_session):
        """Test creating and retrieving a {entity} end-to-end."""
        # Arrange
        request = create_test_{entity}_create_request(name="Integration Test {Domain}")
        repository = {Domain}Repository(test_db_session)

        with patch("app.{domain}.service.event_bus", EventBus()):
            # Act - Create
            created_{entity} = await create_{entity}(request, repository=repository)
            await test_db_session.commit()

            # Act - Get
            retrieved_{entity} = await get_{entity}(created_{entity}.id, repository=repository)
            await test_db_session.commit()

            # Assert
            assert retrieved_{entity} is not None
            assert retrieved_{entity}.id == created_{entity}.id
            assert retrieved_{entity}.name == "Integration Test {Domain}"

    @pytest.mark.asyncio
    async def test_create_update_get_{entity}_integration(self, test_db_session):
        """Test creating, updating, and retrieving a {entity}."""
        # Arrange
        create_request = create_test_{entity}_create_request(name="Original Name")
        update_request = create_test_{entity}_update_request(name="Updated Name")
        repository = {Domain}Repository(test_db_session)

        with patch("app.{domain}.service.event_bus", EventBus()):
            # Act - Create
            created_{entity} = await create_{entity}(create_request, repository=repository)
            await test_db_session.commit()

            # Act - Update
            await update_{entity}(created_{entity}.id, update_request, repository=repository)
            await test_db_session.commit()

            # Act - Get
            retrieved_{entity} = await get_{entity}(created_{entity}.id, repository=repository)
            await test_db_session.commit()

            # Assert
            assert retrieved_{entity} is not None
            assert retrieved_{entity}.name == "Updated Name"

    @pytest.mark.asyncio
    async def test_create_delete_get_{entity}_integration(self, test_db_session):
        """Test creating, deleting, and attempting to retrieve a {entity}."""
        # Arrange
        request = create_test_{entity}_create_request(name="To Delete")
        repository = {Domain}Repository(test_db_session)

        with patch("app.{domain}.service.event_bus", EventBus()):
            # Act - Create
            created_{entity} = await create_{entity}(request, repository=repository)
            await test_db_session.commit()

            # Act - Delete
            deleted = await delete_{entity}(created_{entity}.id, repository=repository)
            await test_db_session.commit()

            # Act - Get
            retrieved_{entity} = await get_{entity}(created_{entity}.id, repository=repository)
            await test_db_session.commit()

            # Assert
            assert deleted is True
            assert retrieved_{entity} is None

    @pytest.mark.asyncio
    async def test_create_multiple_and_get_all_integration(self, test_db_session):
        """Test creating multiple {domain}s and retrieving all."""
        # Arrange
        request1 = create_test_{entity}_create_request(name="{Domain} 1")
        request2 = create_test_{entity}_create_request(name="{Domain} 2")
        repository = {Domain}Repository(test_db_session)

        with patch("app.{domain}.service.event_bus", EventBus()):
            # Act - Create multiple
            await create_{entity}(request1, repository=repository)
            await test_db_session.commit()
            await create_{entity}(request2, repository=repository)
            await test_db_session.commit()

            # Act - Get all
            all_{domain}s = await get_all_{domain}s(repository=repository)
            await test_db_session.commit()

            # Assert
            assert len(all_{domain}s) == 2
            assert any({entity}.name == "{Domain} 1" for {entity} in all_{domain}s)
            assert any({entity}.name == "{Domain} 2" for {entity} in all_{domain}s)

    @pytest.mark.asyncio
    async def test_{entity}_created_event_published_integration(self, test_db_session):
        """Test that {Domain}CreatedEvent is published when creating {entity}."""
        # Arrange
        request = create_test_{entity}_create_request(name="Event Test")
        repository = {Domain}Repository(test_db_session)
        event_bus = EventBus()
        published_events = []

        async def capture_event(event):
            published_events.append(event)

        event_bus.subscribe("{entity}.created", capture_event)

        with patch("app.{domain}.service.event_bus", event_bus):
            # Act
            created_{entity} = await create_{entity}(request, repository=repository)
            await test_db_session.commit()

            # Assert
            assert len(published_events) == 1
            assert isinstance(published_events[0], {Domain}CreatedEvent)
            assert published_events[0].{entity}_id == created_{entity}.id
            assert published_events[0].name == "Event Test"

    @pytest.mark.asyncio
    async def test_update_nonexistent_{entity}_returns_none_integration(self, test_db_session):
        """Test updating non-existent {entity} returns None."""
        # Arrange
        update_request = create_test_{entity}_update_request(name="Updated")
        repository = {Domain}Repository(test_db_session)

        with patch("app.{domain}.service.event_bus", EventBus()):
            # Act
            result = await update_{entity}(999, update_request, repository=repository)
            await test_db_session.commit()

            # Assert
            assert result is None

    @pytest.mark.asyncio
    async def test_delete_nonexistent_{entity}_returns_false_integration(self, test_db_session):
        """Test deleting non-existent {entity} returns False."""
        # Arrange
        repository = {Domain}Repository(test_db_session)

        with patch("app.{domain}.service.event_bus", EventBus()):
            # Act
            result = await delete_{entity}(999, repository=repository)
            await test_db_session.commit()

            # Assert
            assert result is False
